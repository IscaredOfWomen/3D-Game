<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Parkour Level - Capsule Collision</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>

<!-- Include Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/controls/PointerLockControls.js"></script>

<script>
  // Scene setup
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB); // Sky blue
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Lighting
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(10, 50, 10);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040));

  // Platforms
  const platforms = [];
  const platformMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });

  function createPlatform(width, height, depth, position) {
    const geometry = new THREE.BoxGeometry(width, height, depth);
    const platform = new THREE.Mesh(geometry, platformMaterial);
    platform.position.set(position.x, position.y, position.z);
    scene.add(platform);
    platforms.push(platform);
  }

  createPlatform(10, 1, 10, {x: 0, y: 5, z: -20});
  createPlatform(15, 1, 15, {x: 20, y: 8, z: -40});
  createPlatform(20, 1, 20, {x: 50, y: 12, z: -70});
  createPlatform(25, 1, 25, {x: 90, y: 16, z: -110});
  createPlatform(30, 1, 30, {x: 140, y: 20, z: -160});

  // Capsule collider
  const capsule = {
    start: new THREE.Vector3(0, 9.5, 0),
    end: new THREE.Vector3(0, 10.5, 0),
    radius: 0.5
  };

  // Camera controlled via capsule end
  camera.position.copy(capsule.end);

  // Pointer lock controls
  const controls = new THREE.PointerLockControls(camera, renderer.domElement);
  document.body.addEventListener('click', () => controls.lock());

  // Movement
  let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
  let isJumping = false;
  let velocityY = 0;
  const moveSpeed = 0.5;

  document.addEventListener('keydown', (event) => {
    if (event.key === 'w') moveForward = true;
    if (event.key === 's') moveBackward = true;
    if (event.key === 'a') moveLeft = true;
    if (event.key === 'd') moveRight = true;
    if (event.key === ' ' && !isJumping) {
      velocityY = 1.2;
      isJumping = true;
    }
  });

  document.addEventListener('keyup', (event) => {
    if (event.key === 'w') moveForward = false;
    if (event.key === 's') moveBackward = false;
    if (event.key === 'a') moveLeft = false;
    if (event.key === 'd') moveRight = false;
  });

  function checkCollisions() {
    let onGround = false;

    const center = capsule.start.clone().add(capsule.end).multiplyScalar(0.5);
    const height = capsule.end.y - capsule.start.y;
    const capsuleBox = new THREE.Box3().setFromCenterAndSize(
      center,
      new THREE.Vector3(capsule.radius * 2, height + capsule.radius * 2, capsule.radius * 2)
    );

    for (const platform of platforms) {
      const platformBox = new THREE.Box3().setFromObject(platform);

      if (capsuleBox.intersectsBox(platformBox)) {
        if (capsule.start.y - capsule.radius >= platform.position.y &&
            capsule.start.y - capsule.radius <= platform.position.y + 1) {
          // Snap capsule above the platform
          const newY = platform.position.y + 1 + height;
          capsule.start.y = newY - height;
          capsule.end.y = newY;
          velocityY = 0;
          isJumping = false;
          onGround = true;
          break;
        }
      }
    }

    return onGround;
  }

  function animate() {
    requestAnimationFrame(animate);

    // Gravity
    velocityY -= 0.05;
    capsule.start.y += velocityY;
    capsule.end.y += velocityY;

    // Check collisions
    if (checkCollisions() === false && capsule.start.y < -50) {
      capsule.start.set(0, 9.5, 0);
      capsule.end.set(0, 10.5, 0);
      velocityY = 0;
    }

    // Movement
    const direction = new THREE.Vector3();
    if (moveForward) direction.z -= 1;
    if (moveBackward) direction.z += 1;
    if (moveLeft) direction.x -= 1;
    if (moveRight) direction.x += 1;

    if (direction.lengthSq() > 0) {
      direction.normalize();
      direction.applyEuler(camera.rotation);
      capsule.start.addScaledVector(direction, moveSpeed);
      capsule.end.addScaledVector(direction, moveSpeed);
    }

    // Keep camera at capsule's top
    camera.position.copy(capsule.end);

    renderer.render(scene, camera);
  }

  animate();

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>

</body>
</html>
